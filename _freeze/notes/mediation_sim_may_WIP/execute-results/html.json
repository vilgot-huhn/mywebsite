{
  "hash": "a7150557fc2734a593d0dc7df3a8a142",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"mediation_sim_may_WIP\"\nformat: html\ndate: 2025-05-27\nauthor: \"Vilgot Huhn\"\ncategories: [Mediation]\nexecute:\n  freeze: true\n---\n\n\n\n\n\n## Building a generative model step by step\n\nMy goal here is to build a model that describes the essential aspects of the data-generating process that our statistical test will attempt to estimate.\n\nEach individual will be part of either the IU treatment group or the MC treatment group. For the duration of the treatment, the mediator is assumed to gradually change in an approximately linear way. Before considering the comparisons between groups, let's first imagine a patient in one group with a changing mediator, $m^a$. The residuals of the model $\\sigma$ is assumed to be normally distributed with a mean of 0. $t$ is a variable that represent time, which can be weeks from 0 to 9.\n\n$$\nm_i \\sim N(\\mu_i,\\sigma) \\\\\n\\mu_i = \\alpha  +  \\beta t_i\n$$\n\nFor now let's just imagine the data-generating process for a single patient. When generating data parameters like $\\alpha$ and $\\beta$ will have \"priors\" that determine the distribution that data-points are drawn from. For our purposes now the input in those distribution functions are somewhat arbitrary, and they do not represent any thought through Bayesian priors. Because I'm not yet trying to model *uncertainty*, I'll skip specifying $\\sigma$ as a distribution, instead it will be set to = 0.3.\n\n$$\n\\alpha \\sim N(0,1) \\\\\n\\beta \\sim N(-0.1,0.05)\n$$\n\n$\\alpha$ now contains the normal intercept (week = 0) standard deviation for the mediator, while $\\beta$ represents the average slope of the mediator, as well as the heterogeneity of slopes. Let's simulate and plot 1 patient:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nn <- 1\nmediator_intercept_sd <- 1\navg_mediator_slope <- -0.1\nmediator_slope_sd <- 0.05\nweeks <- 0:9\nsigma <- 0.3\n\nm_1 <- rnorm(n, 0, mediator_intercept_sd) + rnorm(n, avg_mediator_slope, mediator_slope_sd)*weeks + rnorm((n*length(weeks)), 0, sigma)\n\nplot(weeks,m_1, ylim = c(-2,2))\n```\n\n::: {.cell-output-display}\n![](mediation_sim_may_WIP_files/figure-html/unnamed-chunk-1-1.png){width=672}\n:::\n:::\n\n\n\nSome additional things to be explicit about: $m_i$ is changing linearly, if not for $\\sigma$. This $\\sigma$ can be seen as representing both \"measurement error\" and exogenous influences. While our treatment is hypothesized to affect the mediator, it is not likely to be the *only* thing affecting the mediator. We also imagine that the change is *heterogenous*; the treatment is not expected to work equally for everyone.\n\nNow let's model how this might look for many different patients $j=1,...,n$. The value of a datapoint $\\mu_i$ (if not for it's error/exogenous influences) can now be given by this formula:\n\n$$\nm_i \\sim N(\\mu_i,\\sigma) \\\\\n\\mu_{i} = \\alpha_{j[i]} \\ + \\ \\beta_{j[i]}t_i \\\\\n\\alpha_j \\sim N(0,1) \\\\\n\\beta_j \\sim N(-0.1,0.05) \\\\\n$$\n\nThe only thing that has changed is that we're now imagining that the slopes and intercepts beloing to many different patients. To generate this we could simply loop the code many times.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nn <- 7 #note that the code calls nr patients \"n\" instead of j.\nmediator_intercept_sd <- 1\navg_mediator_slope <- -0.1\nmediator_slope_sd <- 0.05\nweeks <- 0:9\nsigma <- 0.3\nrho <- -0.15\n\ndf <- data.frame(m = c(), week = c(), id = c())\n\nfor(i in 1:n){\nm_1 <- rnorm(1, 0, mediator_intercept_sd) + rnorm(1, avg_mediator_slope, mediator_slope_sd)*weeks + rnorm((length(weeks)), 0, sigma)\ndf <- rbind.data.frame(df,data.frame(m = m_1, week = weeks, id = rep(i, times = 10)))\n}\n```\n:::\n\n\n\nIn real data it is common to see a negative slope-intercept correlation where a higher value on an individuals $\\alpha$ would be associated with a more negative $\\beta$. Our data-generating process should model this as well. To achieve this we need to let intercepts and slopes them be drawn from a multivariate normal distribution.\n\n$$\n\\begin{align}\ny_i &\\sim N(\\mu_i,\\sigma) \\\\\n\\mu_i &= \\alpha_{j[i]} + \\beta_{j[i]}t_i \\\\\n\\begin{pmatrix} \\alpha_j \\\\ \\beta_j \\end{pmatrix} &\\sim \\text{MVN}\\left(\\begin{pmatrix} \\mu_\\alpha \\\\ \\mu_\\beta \\end{pmatrix}, \\Sigma\\right) \\\\\n\\mu_\\alpha &= 0 \\\\\n\\mu_\\beta &= -0.1 \\\\\n\\Sigma &= \\begin{pmatrix} \\sigma_\\alpha^2 & \\rho\\sigma_\\alpha\\sigma_\\beta \\\\ \\rho\\sigma_\\alpha\\sigma_\\beta & \\sigma_\\beta^2 \\end{pmatrix} \\\\\n\\rho &= -0.15 \\\\\n\\sigma_\\alpha &= 1 \\\\\n\\sigma_\\beta &= 0.05\n\\end{align}\n$$\n\n$\\Sigma$ now represent a common covariance matrix for the slopes and intercepts. The diagonal of the matrix represent the intercept and slope variances for earlier, but we now also have a $\\rho\\sigma_\\alpha \\sigma_\\beta$ that represents the correlation. When generating data I've set it to -0.15.\n\nUpdating the code and looping for 7 patients looks like this:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Now with slope-intercept correlation\nn <- 7 #note that the code calls nr patients \"n\" instead of j.\nmediator_intercept_sd <- 1\navg_mediator_slope <- -0.1\nmediator_slope_sd <- 0.05\nweeks <- 0:9\nsigma <- 0.3\nrho <- -0.15\n\n# Set up multivariate normal parameters\nmu <- c(0, avg_mediator_slope)  # means for intercept and slope\nSigma <- matrix(c(mediator_intercept_sd^2, \n                  rho * mediator_intercept_sd * mediator_slope_sd,\n                  rho * mediator_intercept_sd * mediator_slope_sd, \n                  mediator_slope_sd^2), \n                nrow = 2, ncol = 2)\n\ndf <- data.frame(m = c(), week = c(), id = c())\n\nfor(i in 1:n){\n  # Generate correlated intercept and slope for this participant\n  params <- MASS::mvrnorm(1, mu = mu, Sigma = Sigma)\n  alpha_i <- params[1]  # intercept\n  beta_i <- params[2]   # slope\n  \n  # Calculate values for all weeks for this participant\n  m_1 <- alpha_i + beta_i * weeks + rnorm(length(weeks), 0, sigma)\n  \n  df <- rbind.data.frame(df, data.frame(m = m_1, week = weeks, id = rep(i, times = length(weeks))))\n}\n```\n:::\n\n\n\nLet's plot it:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np <- ggplot(df, aes(y = m, x = week, group = as.factor(id), color = as.factor(id))) + geom_point(aes(y = m), alpha = 0.8) + \n  geom_line(aes(y = m), alpha = 0.8) +\n  theme_minimal()\n\nprint(p)\n```\n\n::: {.cell-output-display}\n![](mediation_sim_may_WIP_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n\n### Modeling the outcome\n\nThe outcome (worry symptoms) we imagine will be affected by treatment in a similar way, decreasing linearly as patients spend time working with the treatment protocol, while being measured with some degree of error. Importantly the outcome will be partially affected by the mediator and partially will have exogenous influences.\n\nWe can expand the model to now instead describe two results $y_i$ and $m_i$. Since we model two \"outcomes\" we also get two residuals $\\sigma_y$ and $\\sigma_m$.\n\n$$\n\\begin{align}\ny_i &\\sim N(\\mu_{y,i}, \\sigma_y) \\\\\nm_i &\\sim N(\\mu_{m,i}, \\sigma_m) \\\\\n\\mu_{y,i} &= \\alpha_{y,j[i]} + \\beta_{y,j[i]}t_i + \\gamma_{j[i]}(m_i-\\bar{m_j}) \\\\\n\\mu_{m,i} &= \\alpha_{m,j[i]} + \\beta_{m,j[i]}t_i \\\\\n\\begin{pmatrix} \\alpha_{m,j} \\\\ \\beta_{m,j} \\\\ \\alpha_{y,j} \\\\ \\beta_{y,j} \\\\ \\gamma_j \\end{pmatrix} &\\sim \\text{MVN}\\left(\\begin{pmatrix} \\mu_{\\alpha,m} \\\\ \\mu_{\\beta,m} \\\\ \\mu_{\\alpha,y} \\\\ \\mu_{\\beta,y} \\\\ \\mu_{\\gamma} \\end{pmatrix}, \\Sigma\\right) \\\\\n\\end{align}\n$$\n\nA lot of things have happened in this step. Our alphas and betas now have subscripts that both relate them to either the outcome or the mediator. We've also added a $\\gamma_j$ which describe the effect of the mediator. **Note** that this now assumes a constant mediator-outcome relationship for each participant $j$. **Note** Not centering the parameter meant it basically pushed y values further from zero. Now while centered it instead represents some sort of average slope of the mediator (balancing on an axis in the middle of the dataset...)\nConstant in the sense that it doesn't vary over time; the relationship is however allowed to vary by participant.\n\nImportantly we now have a joint covariance matrix $\\Sigma$ that structures the multivariate normal distribution which all individual level parameters are drawn from.\n\n**Expanded covariance matrix:**\n\n$$\n\\Sigma = \\begin{pmatrix}\n\\sigma_{\\alpha_m}^2 & \\rho_{\\alpha_m,\\beta_m}\\sigma_{\\alpha_m}\\sigma_{\\beta_m} & \\rho_{\\alpha_m,\\alpha_y}\\sigma_{\\alpha_m}\\sigma_{\\alpha_y} & \\rho_{\\alpha_m,\\beta_y}\\sigma_{\\alpha_m}\\sigma_{\\beta_y} & \\rho_{\\alpha_m,\\gamma}\\sigma_{\\alpha_m}\\sigma_{\\gamma} \\\\\n\\cdot & \\sigma_{\\beta_m}^2 & \\rho_{\\beta_m,\\alpha_y}\\sigma_{\\beta_m}\\sigma_{\\alpha_y} & \\rho_{\\beta_m,\\beta_y}\\sigma_{\\beta_m}\\sigma_{\\beta_y} & \\rho_{\\beta_m,\\gamma}\\sigma_{\\beta_m}\\sigma_{\\gamma} \\\\\n\\cdot & \\cdot & \\sigma_{\\alpha_y}^2 & \\rho_{\\alpha_y,\\beta_y}\\sigma_{\\alpha_y}\\sigma_{\\beta_y} & \\rho_{\\alpha_y,\\gamma}\\sigma_{\\alpha_y}\\sigma_{\\gamma} \\\\\n\\cdot & \\cdot & \\cdot & \\sigma_{\\beta_y}^2 & \\rho_{\\beta_y,\\gamma}\\sigma_{\\beta_y}\\sigma_{\\gamma} \\\\\n\\cdot & \\cdot & \\cdot & \\cdot & \\sigma_{\\gamma}^2\n\\end{pmatrix}\n$$\n\nWhere $\\alpha_{m,j}, \\beta_{m,j}$ are mediator intercept and slope for participant $j$. $\\alpha_{y,j}, \\beta_{y,j}$ are their outcome intercept and slope, $\\gamma_j$ is their mediator-outcome relationship.\n\nThese slopes and intercepts drawn from a multivariate normal distribution. Like before $\\sigma_{\\alpha}$ and $\\sigma_{\\beta}$ describe the intercept standard deviation and heterogeneity of the change over time, but they now have subscripts that specify whether they belong to the mediator or the outcome. We describe heterogeneity of the mediator-outcome relationship with $\\sigma_{\\gamma}$.\n\nWe now also have ten (!) $\\rho$ terms that capture the correlations between individuals slopes and intercepts.\n\n### Let's think through these one by one!\n\n-   $\\rho_{\\alpha_m,\\beta_m}$ is the slope-intercept correlation that we previously defined in the model without the outcome. This should probably be slightly negative to reflect that people who are already at a high level in the mediator tend to have less room to get even worse (and vice versa). A \"regression towards the mean\"-like effect.\n-   $\\rho_{\\alpha_m,\\alpha_y}$ is the correlation between the intercept of the mediator and the intercept of the outcome. This should be moderately positive to reflect that individuals with a high level of our mediating variable (e.g. intolerance of uncertainty) tend to be more worried (at the start of treatment).\n-   $\\rho_{\\alpha_m,\\beta_y}$ is more conceptually tricky. This represents whether individuals high on the mediator at start of treatment tend to change more in the outcome. My stab at it would be that this should also be a slight negative correlation, but probably weaker than the slope-intercept correlation for the mediator itself.\n-   $\\rho_{\\alpha_m,\\gamma}$ represents the relationship between an individuals mediator-outcome relationship, and their initial level of the mediator. For example, do individuals with a higher level of negative metacognitions beforehand also have a stronger overall relationship between their negative metacognitions and their worry? I'm not sure what to make of that. My first hunch is no; while there would be an overall relationship between the mediator and the outcome, $\\mu_\\gamma$, it wouldn't necessarily vary by initial negative metacognition level.\n-   $\\rho_{\\beta_m,\\alpha_y}$ is similarly tricky but like $\\rho_{\\alpha_m,\\beta_y}$ I would argue for \"slightly negative but less so than within variable intercept-slope correlation\"\n-   $\\rho_{\\beta_m,\\beta_y}$ is potentially a very relevant parameter of interest. This should be positive. **Individuals whose mediator change more should have outcomes that change more.**\n-   $\\rho_{\\beta_m,\\gamma}$ is also tricky. It represents how mediator slope relates to the mediator-outcome relationship, for a given participant. One could perhaps frame it as a type of individual differences in treatment response. Perhaps participants where the mediator changes more are the same participants where the mediator is strongly related to the outcome. Now that I type it out, that sounds pretty reasonable.\n-   $\\rho_{\\alpha_y,\\beta_y}$ is the slope-intercept correlation for the outcome. In line with previous reasoning: probably slightly negative.\n-   $\\rho_{\\alpha_y,\\gamma}$ is the relationship between initial worry and the mediator-outcome relationship. Since that's the flipside of $\\rho_{\\alpha_m,\\gamma}$ similar reasoning should hold.\n-   $\\rho_{\\beta_y,\\gamma}$ is also tricky. It should probably be similar to $\\rho_{\\beta_m,\\gamma}$, so that those whose outcome change more tend to have a stronger mediator-outcome relationship (since we're imagining they change *because* of the changing mediator.)\n\nFinally we can complicate the model even further by adding a correlation between the residuals ($\\sigma_m$ and $\\sigma_y$). The outcome is then instead a linear predictor $y_i = \\mu_{y,i} + \\epsilon_{y,i}$ and $\\epsilon$ comes from a multivariate normal distribution that contain both $\\sigma^2_y$, $\\sigma^2_m$ and their correlation $\\rho_{\\epsilon}\\sigma_m\\sigma_y$.\n\n**Should we posit such a relationship?** I think it's unclear. We're then saying that despite all these things we're describing, our $\\boldsymbol\\mu$s and our $\\rho$s and our $\\gamma$s, there's still an additional, not yet captured, relationship between the mediator and the outcome.\n\nThe code below contains it, but I will set the relationship to zero when generating data.\n\n(*Note.* Unlike the previous code I haven't done any checks on whether this fully works).\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nn <- 7 #note that the code calls nr patients \"n\" instead of j.\n\n# Parameters for the 5-dimensional MVN\nmu_alpha_m <- 0        # specify mediator intercept mean\nmu_beta_m <- -0.1      # specify mediator slope mean\nmu_alpha_y <- 0        # specify outcome intercept mean\nmu_beta_y <- -0.11     # specify outcome slope mean  \nmu_gamma <- 0.8       # specify mediator-outcome relationship mean\n\n# Standard deviations for random effects\nsd_alpha_m <- 1        # specify mediator intercept SD\nsd_beta_m <- 0.06      # specify mediator slope SD\nsd_alpha_y <- 0.95      # specify outcome intercept SD\nsd_beta_y <- 0.04      # specify outcome slope SD\nsd_gamma <- 0.2        # specify mediator-outcome relationship SD\n\n# Residual parameters\nsigma_m <- 0.3\nsigma_y <- 0.4\nrho_epsilon <- 0     # residual correlation\n\nweeks <- 0:9\n\n# Set up 5-dimensional multivariate normal parameters\nmu_vec <- c(mu_alpha_m, mu_beta_m, mu_alpha_y, mu_beta_y, mu_gamma)\n\n# Create 5x5 covariance matrix (you can specify correlations as needed)\nrho_alpha_m_beta_m <- -0.15    # mediator slope-intercept correlation\nrho_alpha_m_alpha_y <- 0.9     # mediator-outcome intercept correlation\nrho_alpha_m_beta_y <- -0.1     # mediator-intercept outcome-slope correlation\nrho_alpha_m_gamma <- 0         # mediator intercept-mediator effect correlation\nrho_beta_m_alpha_y <- 0        # mediator slope-outcome intercept correlation\nrho_beta_m_beta_y <- 0.24      # mediator slope-outcome slope correlation\nrho_beta_m_gamma <- 0.25       # mediator slope-mediator effect correlation\n\nrho_alpha_y_beta_y <- - 0.16   # outcome slope-intercept correlation\nrho_alpha_y_gamma <- 0         # outcome intercept-mediator effect correlation\nrho_beta_y_gamma <- 0.20       # outcome slope-mediator effect correlation\n\nSigma_RE <- matrix(0, nrow = 5, ncol = 5)\ndiag(Sigma_RE) <- c(sd_alpha_m^2, sd_beta_m^2, sd_alpha_y^2, sd_beta_y^2, sd_gamma^2)\n\n# Fill in correlations (symmetric matrix)\nSigma_RE[1,2] <- Sigma_RE[2,1] <- rho_alpha_m_beta_m * sd_alpha_m * sd_beta_m\nSigma_RE[1,3] <- Sigma_RE[3,1] <- rho_alpha_m_alpha_y * sd_alpha_m * sd_alpha_y\nSigma_RE[1,4] <- Sigma_RE[4,1] <- rho_alpha_m_beta_y * sd_alpha_m * sd_beta_y\nSigma_RE[1,5] <- Sigma_RE[5,1] <- rho_alpha_m_gamma * sd_alpha_m * sd_gamma\n\nSigma_RE[2,3] <- Sigma_RE[3,2] <- rho_beta_m_alpha_y * sd_beta_m * sd_alpha_y\nSigma_RE[2,4] <- Sigma_RE[4,2] <- rho_beta_m_beta_y * sd_beta_m * sd_beta_y\nSigma_RE[2,5] <- Sigma_RE[5,2] <- rho_beta_m_gamma * sd_beta_m * sd_gamma\n\nSigma_RE[3,4] <- Sigma_RE[4,3] <- rho_alpha_y_beta_y * sd_alpha_y * sd_beta_y\nSigma_RE[3,5] <- Sigma_RE[5,3] <- rho_alpha_y_gamma * sd_alpha_y * sd_gamma\n\nSigma_RE[4,5] <- Sigma_RE[5,4] <- rho_beta_y_gamma * sd_beta_y * sd_gamma\n\n# Residual covariance matrix\nSigma_res <- matrix(c(sigma_m^2, rho_epsilon * sigma_m * sigma_y,\n                      rho_epsilon * sigma_m * sigma_y, sigma_y^2), \n                    nrow = 2, ncol = 2)\n\ndf <- data.frame(m = c(), y = c(), week = c(), id = c())\n\nfor(i in 1:n){\n  # Generate 5 correlated random effects for this participant\n  params <- mvrnorm(1, mu = mu_vec, Sigma = Sigma_RE)\n  alpha_m_i <- params[1]  # mediator intercept\n  beta_m_i <- params[2]   # mediator slope\n  alpha_y_i <- params[3]  # outcome intercept\n  beta_y_i <- params[4]   # outcome slope\n  gamma_i <- params[5]    # mediator-outcome relationship\n  \n  # Generate correlated residuals for all timepoints\n  residuals <- mvrnorm(length(weeks), mu = c(0, 0), Sigma = Sigma_res)\n  epsilon_m <- residuals[, 1]\n  epsilon_y <- residuals[, 2]\n  \n  # Calculate mediator values\n  mu_m <- alpha_m_i + beta_m_i * weeks\n  m_vals <- mu_m + epsilon_m\n  \n    # CENTER THE MEDIATOR BY PARTICIPANT\n  m_centered <- m_vals - mean(m_vals)\n  \n  # Calculate outcome values using CENTERED mediator\n  mu_y <- alpha_y_i + beta_y_i * weeks + gamma_i * m_centered\n  y_vals <- mu_y + epsilon_y\n  \n  df <- rbind.data.frame(df, data.frame(m = m_vals, y = y_vals, week = weeks,\n                                        id = rep(i, times = length(weeks))))\n}\n```\n:::\n\n\n\nMy aim for this code is that it can be used as a tool to test and make sense of different available methods for mediation analysis.\n\nFor now, let's just plot both mediator and\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np <- ggplot(df, aes(x = week, group = as.factor(id), color = as.factor(id))) + geom_point(aes(y = m), alpha = 0.8) + \n  geom_line(aes(y = m), alpha = 0.8) +\n  geom_point(aes(y = y), alpha = 0.4) +\n  geom_line(aes(y = y), alpha = 0.4, linetype = \"dashed\") +\n  labs(color = \"ID\", y = \"Value\") +\n  theme_minimal()\n\nprint(p)\n```\n\n::: {.cell-output-display}\n![](mediation_sim_may_WIP_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n\n\n### Appendix: Maximal model including correlated residuals.\n\n**Note.** Not yet updated $\\gamma$ to apply to centered $m$\n\n$$\n\\begin{align}\ny_i &= \\mu_{y,i} + \\epsilon_{y,i} \\\\\nm_i &= \\mu_{m,i} + \\epsilon_{m,i} \\\\\n\\mu_{y,i} &= \\alpha_{y,j[i]} + \\beta_{y,j[i]}t_i + \\gamma_{j[i]}m_i \\\\\n\\mu_{m,i} &= \\alpha_{m,j[i]} + \\beta_{m,j[i]}t_i \\\\\n\\begin{pmatrix} \\alpha_{m,j} \\\\ \\beta_{m,j} \\\\ \\alpha_{y,j} \\\\ \\beta_{y,j} \\\\ \\gamma_j \\end{pmatrix} &\\sim \\text{MVN}\\left(\\begin{pmatrix} \\mu_{\\alpha,m} \\\\ \\mu_{\\beta,m} \\\\ \\mu_{\\alpha,y} \\\\ \\mu_{\\beta,y} \\\\ \\mu_{\\gamma} \\end{pmatrix}, \\Sigma_{RE}\\right) \\\\\n\\begin{pmatrix} \\epsilon_{m,i} \\\\ \\epsilon_{y,i} \\end{pmatrix} &\\sim \\text{MVN}\\left(\\begin{pmatrix} 0 \\\\ 0 \\end{pmatrix}, \\begin{pmatrix} \\sigma_m^2 & \\rho_{\\epsilon}\\sigma_m\\sigma_y \\\\ \\rho_{\\epsilon}\\sigma_m\\sigma_y & \\sigma_y^2 \\end{pmatrix}\\right)\n\\end{align}\n$$\n",
    "supporting": [
      "mediation_sim_may_WIP_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}