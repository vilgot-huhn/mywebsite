<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Vilgot Huhn">
<meta name="dcterms.date" content="2025-05-27">

<title>mediation_sim_may_WIP – Vilgot’s website</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Vilgot’s website</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../blog.html"> 
<span class="menu-text">personal substack</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../posts.html"> 
<span class="menu-text">R/stats/psych posts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../projects.html"> 
<span class="menu-text">notes</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools tools-wide">
    <a href="https://twitter.com/vilgothuhn" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-twitter"></i></a>
    <a href="https://github.com/vilgot-huhn/mywebsite" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
    <a href="https://unconfusion.substack.com/" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-substack"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#building-a-generative-model-step-by-step" id="toc-building-a-generative-model-step-by-step" class="nav-link active" data-scroll-target="#building-a-generative-model-step-by-step">Building a generative model step by step</a>
  <ul class="collapse">
  <li><a href="#modeling-the-outcome" id="toc-modeling-the-outcome" class="nav-link" data-scroll-target="#modeling-the-outcome">Modeling the outcome</a></li>
  <li><a href="#lets-think-through-these-one-by-one" id="toc-lets-think-through-these-one-by-one" class="nav-link" data-scroll-target="#lets-think-through-these-one-by-one">Let’s think through these one by one!</a></li>
  <li><a href="#appendix-maximal-model-including-correlated-residuals." id="toc-appendix-maximal-model-including-correlated-residuals." class="nav-link" data-scroll-target="#appendix-maximal-model-including-correlated-residuals.">Appendix: Maximal model including correlated residuals.</a></li>
  </ul></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">mediation_sim_may_WIP</h1>
  <div class="quarto-categories">
    <div class="quarto-category">Mediation</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Vilgot Huhn </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 27, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="building-a-generative-model-step-by-step" class="level2">
<h2 class="anchored" data-anchor-id="building-a-generative-model-step-by-step">Building a generative model step by step</h2>
<p>My goal here is to build a model that describes the essential aspects of the data-generating process that our statistical test will attempt to estimate.</p>
<p>Each individual will be part of either the IU treatment group or the MC treatment group. For the duration of the treatment, the mediator is assumed to gradually change in an approximately linear way. Before considering the comparisons between groups, let’s first imagine a patient in one group with a changing mediator, <span class="math inline">\(m^a\)</span>. The residuals of the model <span class="math inline">\(\sigma\)</span> is assumed to be normally distributed with a mean of 0. <span class="math inline">\(t\)</span> is a variable that represent time, which can be weeks from 0 to 9.</p>
<p><span class="math display">\[
m_i \sim N(\mu_i,\sigma) \\
\mu_i = \alpha  +  \beta t_i
\]</span></p>
<p>For now let’s just imagine the data-generating process for a single patient. When generating data parameters like <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> will have “priors” that determine the distribution that data-points are drawn from. For our purposes now the input in those distribution functions are somewhat arbitrary, and they do not represent any thought through Bayesian priors. Because I’m not yet trying to model <em>uncertainty</em>, I’ll skip specifying <span class="math inline">\(\sigma\)</span> as a distribution, instead it will be set to = 0.3.</p>
<p><span class="math display">\[
\alpha \sim N(0,1) \\
\beta \sim N(-0.1,0.05)
\]</span></p>
<p><span class="math inline">\(\alpha\)</span> now contains the normal intercept (week = 0) standard deviation for the mediator, while <span class="math inline">\(\beta\)</span> represents the average slope of the mediator, as well as the heterogeneity of slopes. Let’s simulate and plot 1 patient:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>mediator_intercept_sd <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>avg_mediator_slope <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.1</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>mediator_slope_sd <span class="ot">&lt;-</span> <span class="fl">0.05</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>weeks <span class="ot">&lt;-</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">9</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>sigma <span class="ot">&lt;-</span> <span class="fl">0.3</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>m_1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="dv">0</span>, mediator_intercept_sd) <span class="sc">+</span> <span class="fu">rnorm</span>(n, avg_mediator_slope, mediator_slope_sd)<span class="sc">*</span>weeks <span class="sc">+</span> <span class="fu">rnorm</span>((n<span class="sc">*</span><span class="fu">length</span>(weeks)), <span class="dv">0</span>, sigma)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(weeks,m_1, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">2</span>,<span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="mediation_sim_may_WIP_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Some additional things to be explicit about: <span class="math inline">\(m_i\)</span> is changing linearly, if not for <span class="math inline">\(\sigma\)</span>. This <span class="math inline">\(\sigma\)</span> can be seen as representing both “measurement error” and exogenous influences. While our treatment is hypothesized to affect the mediator, it is not likely to be the <em>only</em> thing affecting the mediator. We also imagine that the change is <em>heterogenous</em>; the treatment is not expected to work equally for everyone.</p>
<p>Now let’s model how this might look for many different patients <span class="math inline">\(j=1,...,n\)</span>. The value of a datapoint <span class="math inline">\(\mu_i\)</span> (if not for it’s error/exogenous influences) can now be given by this formula:</p>
<p><span class="math display">\[
m_i \sim N(\mu_i,\sigma) \\
\mu_{i} = \alpha_{j[i]} \ + \ \beta_{j[i]}t_i \\
\alpha_j \sim N(0,1) \\
\beta_j \sim N(-0.1,0.05) \\
\]</span></p>
<p>The only thing that has changed is that we’re now imagining that the slopes and intercepts beloing to many different patients. To generate this we could simply loop the code many times.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">7</span> <span class="co">#note that the code calls nr patients "n" instead of j.</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>mediator_intercept_sd <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>avg_mediator_slope <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.1</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>mediator_slope_sd <span class="ot">&lt;-</span> <span class="fl">0.05</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>weeks <span class="ot">&lt;-</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">9</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>sigma <span class="ot">&lt;-</span> <span class="fl">0.3</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>rho <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.15</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">m =</span> <span class="fu">c</span>(), <span class="at">week =</span> <span class="fu">c</span>(), <span class="at">id =</span> <span class="fu">c</span>())</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n){</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>m_1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, mediator_intercept_sd) <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, avg_mediator_slope, mediator_slope_sd)<span class="sc">*</span>weeks <span class="sc">+</span> <span class="fu">rnorm</span>((<span class="fu">length</span>(weeks)), <span class="dv">0</span>, sigma)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">rbind.data.frame</span>(df,<span class="fu">data.frame</span>(<span class="at">m =</span> m_1, <span class="at">week =</span> weeks, <span class="at">id =</span> <span class="fu">rep</span>(i, <span class="at">times =</span> <span class="dv">10</span>)))</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In real data it is common to see a negative slope-intercept correlation where a higher value on an individuals <span class="math inline">\(\alpha\)</span> would be associated with a more negative <span class="math inline">\(\beta\)</span>. Our data-generating process should model this as well. To achieve this we need to let intercepts and slopes them be drawn from a multivariate normal distribution.</p>
<p><span class="math display">\[
\begin{align}
y_i &amp;\sim N(\mu_i,\sigma) \\
\mu_i &amp;= \alpha_{j[i]} + \beta_{j[i]}t_i \\
\begin{pmatrix} \alpha_j \\ \beta_j \end{pmatrix} &amp;\sim \text{MVN}\left(\begin{pmatrix} \mu_\alpha \\ \mu_\beta \end{pmatrix}, \Sigma\right) \\
\mu_\alpha &amp;= 0 \\
\mu_\beta &amp;= -0.1 \\
\Sigma &amp;= \begin{pmatrix} \sigma_\alpha^2 &amp; \rho\sigma_\alpha\sigma_\beta \\ \rho\sigma_\alpha\sigma_\beta &amp; \sigma_\beta^2 \end{pmatrix} \\
\rho &amp;= -0.15 \\
\sigma_\alpha &amp;= 1 \\
\sigma_\beta &amp;= 0.05
\end{align}
\]</span></p>
<p><span class="math inline">\(\Sigma\)</span> now represent a common covariance matrix for the slopes and intercepts. The diagonal of the matrix represent the intercept and slope variances for earlier, but we now also have a <span class="math inline">\(\rho\sigma_\alpha \sigma_\beta\)</span> that represents the correlation. When generating data I’ve set it to -0.15.</p>
<p>Updating the code and looping for 7 patients looks like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Now with slope-intercept correlation</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">7</span> <span class="co">#note that the code calls nr patients "n" instead of j.</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>mediator_intercept_sd <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>avg_mediator_slope <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.1</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>mediator_slope_sd <span class="ot">&lt;-</span> <span class="fl">0.05</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>weeks <span class="ot">&lt;-</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">9</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>sigma <span class="ot">&lt;-</span> <span class="fl">0.3</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>rho <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.15</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up multivariate normal parameters</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, avg_mediator_slope)  <span class="co"># means for intercept and slope</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>Sigma <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(mediator_intercept_sd<span class="sc">^</span><span class="dv">2</span>, </span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>                  rho <span class="sc">*</span> mediator_intercept_sd <span class="sc">*</span> mediator_slope_sd,</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>                  rho <span class="sc">*</span> mediator_intercept_sd <span class="sc">*</span> mediator_slope_sd, </span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>                  mediator_slope_sd<span class="sc">^</span><span class="dv">2</span>), </span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>                <span class="at">nrow =</span> <span class="dv">2</span>, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">m =</span> <span class="fu">c</span>(), <span class="at">week =</span> <span class="fu">c</span>(), <span class="at">id =</span> <span class="fu">c</span>())</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n){</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate correlated intercept and slope for this participant</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>  params <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(<span class="dv">1</span>, <span class="at">mu =</span> mu, <span class="at">Sigma =</span> Sigma)</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  alpha_i <span class="ot">&lt;-</span> params[<span class="dv">1</span>]  <span class="co"># intercept</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>  beta_i <span class="ot">&lt;-</span> params[<span class="dv">2</span>]   <span class="co"># slope</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate values for all weeks for this participant</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  m_1 <span class="ot">&lt;-</span> alpha_i <span class="sc">+</span> beta_i <span class="sc">*</span> weeks <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(weeks), <span class="dv">0</span>, sigma)</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">rbind.data.frame</span>(df, <span class="fu">data.frame</span>(<span class="at">m =</span> m_1, <span class="at">week =</span> weeks, <span class="at">id =</span> <span class="fu">rep</span>(i, <span class="at">times =</span> <span class="fu">length</span>(weeks))))</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s plot it:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">y =</span> m, <span class="at">x =</span> week, <span class="at">group =</span> <span class="fu">as.factor</span>(id), <span class="at">color =</span> <span class="fu">as.factor</span>(id))) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> m), <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span> </span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> m), <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="mediation_sim_may_WIP_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="modeling-the-outcome" class="level3">
<h3 class="anchored" data-anchor-id="modeling-the-outcome">Modeling the outcome</h3>
<p>The outcome (worry symptoms) we imagine will be affected by treatment in a similar way, decreasing linearly as patients spend time working with the treatment protocol, while being measured with some degree of error. Importantly the outcome will be partially affected by the mediator and partially will have exogenous influences.</p>
<p>We can expand the model to now instead describe two results <span class="math inline">\(y_i\)</span> and <span class="math inline">\(m_i\)</span>. Since we model two “outcomes” we also get two residuals <span class="math inline">\(\sigma_y\)</span> and <span class="math inline">\(\sigma_m\)</span>.</p>
<p><span class="math display">\[
\begin{align}
y_i &amp;\sim N(\mu_{y,i}, \sigma_y) \\
m_i &amp;\sim N(\mu_{m,i}, \sigma_m) \\
\mu_{y,i} &amp;= \alpha_{y,j[i]} + \beta_{y,j[i]}t_i + \gamma_{j[i]}(m_i-\bar{m_j}) \\
\mu_{m,i} &amp;= \alpha_{m,j[i]} + \beta_{m,j[i]}t_i \\
\begin{pmatrix} \alpha_{m,j} \\ \beta_{m,j} \\ \alpha_{y,j} \\ \beta_{y,j} \\ \gamma_j \end{pmatrix} &amp;\sim \text{MVN}\left(\begin{pmatrix} \mu_{\alpha,m} \\ \mu_{\beta,m} \\ \mu_{\alpha,y} \\ \mu_{\beta,y} \\ \mu_{\gamma} \end{pmatrix}, \Sigma\right) \\
\end{align}
\]</span></p>
<p>A lot of things have happened in this step. Our alphas and betas now have subscripts that both relate them to either the outcome or the mediator. We’ve also added a <span class="math inline">\(\gamma_j\)</span> which describe the effect of the mediator. <strong>Note</strong> that this now assumes a constant mediator-outcome relationship for each participant <span class="math inline">\(j\)</span>. <strong>Note</strong> Not centering the parameter meant it basically pushed y values further from zero. Now while centered it instead represents some sort of average slope of the mediator (balancing on an axis in the middle of the dataset…) Constant in the sense that it doesn’t vary over time; the relationship is however allowed to vary by participant.</p>
<p>Importantly we now have a joint covariance matrix <span class="math inline">\(\Sigma\)</span> that structures the multivariate normal distribution which all individual level parameters are drawn from.</p>
<p><strong>Expanded covariance matrix:</strong></p>
<p><span class="math display">\[
\Sigma = \begin{pmatrix}
\sigma_{\alpha_m}^2 &amp; \rho_{\alpha_m,\beta_m}\sigma_{\alpha_m}\sigma_{\beta_m} &amp; \rho_{\alpha_m,\alpha_y}\sigma_{\alpha_m}\sigma_{\alpha_y} &amp; \rho_{\alpha_m,\beta_y}\sigma_{\alpha_m}\sigma_{\beta_y} &amp; \rho_{\alpha_m,\gamma}\sigma_{\alpha_m}\sigma_{\gamma} \\
\cdot &amp; \sigma_{\beta_m}^2 &amp; \rho_{\beta_m,\alpha_y}\sigma_{\beta_m}\sigma_{\alpha_y} &amp; \rho_{\beta_m,\beta_y}\sigma_{\beta_m}\sigma_{\beta_y} &amp; \rho_{\beta_m,\gamma}\sigma_{\beta_m}\sigma_{\gamma} \\
\cdot &amp; \cdot &amp; \sigma_{\alpha_y}^2 &amp; \rho_{\alpha_y,\beta_y}\sigma_{\alpha_y}\sigma_{\beta_y} &amp; \rho_{\alpha_y,\gamma}\sigma_{\alpha_y}\sigma_{\gamma} \\
\cdot &amp; \cdot &amp; \cdot &amp; \sigma_{\beta_y}^2 &amp; \rho_{\beta_y,\gamma}\sigma_{\beta_y}\sigma_{\gamma} \\
\cdot &amp; \cdot &amp; \cdot &amp; \cdot &amp; \sigma_{\gamma}^2
\end{pmatrix}
\]</span></p>
<p>Where <span class="math inline">\(\alpha_{m,j}, \beta_{m,j}\)</span> are mediator intercept and slope for participant <span class="math inline">\(j\)</span>. <span class="math inline">\(\alpha_{y,j}, \beta_{y,j}\)</span> are their outcome intercept and slope, <span class="math inline">\(\gamma_j\)</span> is their mediator-outcome relationship.</p>
<p>These slopes and intercepts drawn from a multivariate normal distribution. Like before <span class="math inline">\(\sigma_{\alpha}\)</span> and <span class="math inline">\(\sigma_{\beta}\)</span> describe the intercept standard deviation and heterogeneity of the change over time, but they now have subscripts that specify whether they belong to the mediator or the outcome. We describe heterogeneity of the mediator-outcome relationship with <span class="math inline">\(\sigma_{\gamma}\)</span>.</p>
<p>We now also have ten (!) <span class="math inline">\(\rho\)</span> terms that capture the correlations between individuals slopes and intercepts.</p>
</section>
<section id="lets-think-through-these-one-by-one" class="level3">
<h3 class="anchored" data-anchor-id="lets-think-through-these-one-by-one">Let’s think through these one by one!</h3>
<ul>
<li><span class="math inline">\(\rho_{\alpha_m,\beta_m}\)</span> is the slope-intercept correlation that we previously defined in the model without the outcome. This should probably be slightly negative to reflect that people who are already at a high level in the mediator tend to have less room to get even worse (and vice versa). A “regression towards the mean”-like effect.</li>
<li><span class="math inline">\(\rho_{\alpha_m,\alpha_y}\)</span> is the correlation between the intercept of the mediator and the intercept of the outcome. This should be moderately positive to reflect that individuals with a high level of our mediating variable (e.g.&nbsp;intolerance of uncertainty) tend to be more worried (at the start of treatment).</li>
<li><span class="math inline">\(\rho_{\alpha_m,\beta_y}\)</span> is more conceptually tricky. This represents whether individuals high on the mediator at start of treatment tend to change more in the outcome. My stab at it would be that this should also be a slight negative correlation, but probably weaker than the slope-intercept correlation for the mediator itself.</li>
<li><span class="math inline">\(\rho_{\alpha_m,\gamma}\)</span> represents the relationship between an individuals mediator-outcome relationship, and their initial level of the mediator. For example, do individuals with a higher level of negative metacognitions beforehand also have a stronger overall relationship between their negative metacognitions and their worry? I’m not sure what to make of that. My first hunch is no; while there would be an overall relationship between the mediator and the outcome, <span class="math inline">\(\mu_\gamma\)</span>, it wouldn’t necessarily vary by initial negative metacognition level.</li>
<li><span class="math inline">\(\rho_{\beta_m,\alpha_y}\)</span> is similarly tricky but like <span class="math inline">\(\rho_{\alpha_m,\beta_y}\)</span> I would argue for “slightly negative but less so than within variable intercept-slope correlation”</li>
<li><span class="math inline">\(\rho_{\beta_m,\beta_y}\)</span> is potentially a very relevant parameter of interest. This should be positive. <strong>Individuals whose mediator change more should have outcomes that change more.</strong></li>
<li><span class="math inline">\(\rho_{\beta_m,\gamma}\)</span> is also tricky. It represents how mediator slope relates to the mediator-outcome relationship, for a given participant. One could perhaps frame it as a type of individual differences in treatment response. Perhaps participants where the mediator changes more are the same participants where the mediator is strongly related to the outcome. Now that I type it out, that sounds pretty reasonable.</li>
<li><span class="math inline">\(\rho_{\alpha_y,\beta_y}\)</span> is the slope-intercept correlation for the outcome. In line with previous reasoning: probably slightly negative.</li>
<li><span class="math inline">\(\rho_{\alpha_y,\gamma}\)</span> is the relationship between initial worry and the mediator-outcome relationship. Since that’s the flipside of <span class="math inline">\(\rho_{\alpha_m,\gamma}\)</span> similar reasoning should hold.</li>
<li><span class="math inline">\(\rho_{\beta_y,\gamma}\)</span> is also tricky. It should probably be similar to <span class="math inline">\(\rho_{\beta_m,\gamma}\)</span>, so that those whose outcome change more tend to have a stronger mediator-outcome relationship (since we’re imagining they change <em>because</em> of the changing mediator.)</li>
</ul>
<p>Finally we can complicate the model even further by adding a correlation between the residuals (<span class="math inline">\(\sigma_m\)</span> and <span class="math inline">\(\sigma_y\)</span>). The outcome is then instead a linear predictor <span class="math inline">\(y_i = \mu_{y,i} + \epsilon_{y,i}\)</span> and <span class="math inline">\(\epsilon\)</span> comes from a multivariate normal distribution that contain both <span class="math inline">\(\sigma^2_y\)</span>, <span class="math inline">\(\sigma^2_m\)</span> and their correlation <span class="math inline">\(\rho_{\epsilon}\sigma_m\sigma_y\)</span>.</p>
<p><strong>Should we posit such a relationship?</strong> I think it’s unclear. We’re then saying that despite all these things we’re describing, our <span class="math inline">\(\boldsymbol\mu\)</span>s and our <span class="math inline">\(\rho\)</span>s and our <span class="math inline">\(\gamma\)</span>s, there’s still an additional, not yet captured, relationship between the mediator and the outcome.</p>
<p>The code below contains it, but I will set the relationship to zero when generating data.</p>
<p>(<em>Note.</em> Unlike the previous code I haven’t done any checks on whether this fully works).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">7</span> <span class="co">#note that the code calls nr patients "n" instead of j.</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters for the 5-dimensional MVN</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>mu_alpha_m <span class="ot">&lt;-</span> <span class="dv">0</span>        <span class="co"># specify mediator intercept mean</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>mu_beta_m <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.1</span>      <span class="co"># specify mediator slope mean</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>mu_alpha_y <span class="ot">&lt;-</span> <span class="dv">0</span>        <span class="co"># specify outcome intercept mean</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>mu_beta_y <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.11</span>     <span class="co"># specify outcome slope mean  </span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>mu_gamma <span class="ot">&lt;-</span> <span class="fl">0.8</span>       <span class="co"># specify mediator-outcome relationship mean</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Standard deviations for random effects</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>sd_alpha_m <span class="ot">&lt;-</span> <span class="dv">1</span>        <span class="co"># specify mediator intercept SD</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>sd_beta_m <span class="ot">&lt;-</span> <span class="fl">0.06</span>      <span class="co"># specify mediator slope SD</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>sd_alpha_y <span class="ot">&lt;-</span> <span class="fl">0.95</span>      <span class="co"># specify outcome intercept SD</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>sd_beta_y <span class="ot">&lt;-</span> <span class="fl">0.04</span>      <span class="co"># specify outcome slope SD</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>sd_gamma <span class="ot">&lt;-</span> <span class="fl">0.2</span>        <span class="co"># specify mediator-outcome relationship SD</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Residual parameters</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>sigma_m <span class="ot">&lt;-</span> <span class="fl">0.3</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>sigma_y <span class="ot">&lt;-</span> <span class="fl">0.4</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>rho_epsilon <span class="ot">&lt;-</span> <span class="dv">0</span>     <span class="co"># residual correlation</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>weeks <span class="ot">&lt;-</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">9</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up 5-dimensional multivariate normal parameters</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>mu_vec <span class="ot">&lt;-</span> <span class="fu">c</span>(mu_alpha_m, mu_beta_m, mu_alpha_y, mu_beta_y, mu_gamma)</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Create 5x5 covariance matrix (you can specify correlations as needed)</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>rho_alpha_m_beta_m <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.15</span>    <span class="co"># mediator slope-intercept correlation</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>rho_alpha_m_alpha_y <span class="ot">&lt;-</span> <span class="fl">0.9</span>     <span class="co"># mediator-outcome intercept correlation</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>rho_alpha_m_beta_y <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.1</span>     <span class="co"># mediator-intercept outcome-slope correlation</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>rho_alpha_m_gamma <span class="ot">&lt;-</span> <span class="dv">0</span>         <span class="co"># mediator intercept-mediator effect correlation</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>rho_beta_m_alpha_y <span class="ot">&lt;-</span> <span class="dv">0</span>        <span class="co"># mediator slope-outcome intercept correlation</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>rho_beta_m_beta_y <span class="ot">&lt;-</span> <span class="fl">0.24</span>      <span class="co"># mediator slope-outcome slope correlation</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>rho_beta_m_gamma <span class="ot">&lt;-</span> <span class="fl">0.25</span>       <span class="co"># mediator slope-mediator effect correlation</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>rho_alpha_y_beta_y <span class="ot">&lt;-</span> <span class="sc">-</span> <span class="fl">0.16</span>   <span class="co"># outcome slope-intercept correlation</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>rho_alpha_y_gamma <span class="ot">&lt;-</span> <span class="dv">0</span>         <span class="co"># outcome intercept-mediator effect correlation</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>rho_beta_y_gamma <span class="ot">&lt;-</span> <span class="fl">0.20</span>       <span class="co"># outcome slope-mediator effect correlation</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>Sigma_RE <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="dv">5</span>, <span class="at">ncol =</span> <span class="dv">5</span>)</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a><span class="fu">diag</span>(Sigma_RE) <span class="ot">&lt;-</span> <span class="fu">c</span>(sd_alpha_m<span class="sc">^</span><span class="dv">2</span>, sd_beta_m<span class="sc">^</span><span class="dv">2</span>, sd_alpha_y<span class="sc">^</span><span class="dv">2</span>, sd_beta_y<span class="sc">^</span><span class="dv">2</span>, sd_gamma<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Fill in correlations (symmetric matrix)</span></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>Sigma_RE[<span class="dv">1</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> Sigma_RE[<span class="dv">2</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> rho_alpha_m_beta_m <span class="sc">*</span> sd_alpha_m <span class="sc">*</span> sd_beta_m</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>Sigma_RE[<span class="dv">1</span>,<span class="dv">3</span>] <span class="ot">&lt;-</span> Sigma_RE[<span class="dv">3</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> rho_alpha_m_alpha_y <span class="sc">*</span> sd_alpha_m <span class="sc">*</span> sd_alpha_y</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>Sigma_RE[<span class="dv">1</span>,<span class="dv">4</span>] <span class="ot">&lt;-</span> Sigma_RE[<span class="dv">4</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> rho_alpha_m_beta_y <span class="sc">*</span> sd_alpha_m <span class="sc">*</span> sd_beta_y</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>Sigma_RE[<span class="dv">1</span>,<span class="dv">5</span>] <span class="ot">&lt;-</span> Sigma_RE[<span class="dv">5</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> rho_alpha_m_gamma <span class="sc">*</span> sd_alpha_m <span class="sc">*</span> sd_gamma</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>Sigma_RE[<span class="dv">2</span>,<span class="dv">3</span>] <span class="ot">&lt;-</span> Sigma_RE[<span class="dv">3</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> rho_beta_m_alpha_y <span class="sc">*</span> sd_beta_m <span class="sc">*</span> sd_alpha_y</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>Sigma_RE[<span class="dv">2</span>,<span class="dv">4</span>] <span class="ot">&lt;-</span> Sigma_RE[<span class="dv">4</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> rho_beta_m_beta_y <span class="sc">*</span> sd_beta_m <span class="sc">*</span> sd_beta_y</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>Sigma_RE[<span class="dv">2</span>,<span class="dv">5</span>] <span class="ot">&lt;-</span> Sigma_RE[<span class="dv">5</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> rho_beta_m_gamma <span class="sc">*</span> sd_beta_m <span class="sc">*</span> sd_gamma</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>Sigma_RE[<span class="dv">3</span>,<span class="dv">4</span>] <span class="ot">&lt;-</span> Sigma_RE[<span class="dv">4</span>,<span class="dv">3</span>] <span class="ot">&lt;-</span> rho_alpha_y_beta_y <span class="sc">*</span> sd_alpha_y <span class="sc">*</span> sd_beta_y</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>Sigma_RE[<span class="dv">3</span>,<span class="dv">5</span>] <span class="ot">&lt;-</span> Sigma_RE[<span class="dv">5</span>,<span class="dv">3</span>] <span class="ot">&lt;-</span> rho_alpha_y_gamma <span class="sc">*</span> sd_alpha_y <span class="sc">*</span> sd_gamma</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>Sigma_RE[<span class="dv">4</span>,<span class="dv">5</span>] <span class="ot">&lt;-</span> Sigma_RE[<span class="dv">5</span>,<span class="dv">4</span>] <span class="ot">&lt;-</span> rho_beta_y_gamma <span class="sc">*</span> sd_beta_y <span class="sc">*</span> sd_gamma</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Residual covariance matrix</span></span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>Sigma_res <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(sigma_m<span class="sc">^</span><span class="dv">2</span>, rho_epsilon <span class="sc">*</span> sigma_m <span class="sc">*</span> sigma_y,</span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>                      rho_epsilon <span class="sc">*</span> sigma_m <span class="sc">*</span> sigma_y, sigma_y<span class="sc">^</span><span class="dv">2</span>), </span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>                    <span class="at">nrow =</span> <span class="dv">2</span>, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">m =</span> <span class="fu">c</span>(), <span class="at">y =</span> <span class="fu">c</span>(), <span class="at">week =</span> <span class="fu">c</span>(), <span class="at">id =</span> <span class="fu">c</span>())</span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n){</span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate 5 correlated random effects for this participant</span></span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>  params <span class="ot">&lt;-</span> <span class="fu">mvrnorm</span>(<span class="dv">1</span>, <span class="at">mu =</span> mu_vec, <span class="at">Sigma =</span> Sigma_RE)</span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>  alpha_m_i <span class="ot">&lt;-</span> params[<span class="dv">1</span>]  <span class="co"># mediator intercept</span></span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>  beta_m_i <span class="ot">&lt;-</span> params[<span class="dv">2</span>]   <span class="co"># mediator slope</span></span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>  alpha_y_i <span class="ot">&lt;-</span> params[<span class="dv">3</span>]  <span class="co"># outcome intercept</span></span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>  beta_y_i <span class="ot">&lt;-</span> params[<span class="dv">4</span>]   <span class="co"># outcome slope</span></span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>  gamma_i <span class="ot">&lt;-</span> params[<span class="dv">5</span>]    <span class="co"># mediator-outcome relationship</span></span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate correlated residuals for all timepoints</span></span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>  residuals <span class="ot">&lt;-</span> <span class="fu">mvrnorm</span>(<span class="fu">length</span>(weeks), <span class="at">mu =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>), <span class="at">Sigma =</span> Sigma_res)</span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>  epsilon_m <span class="ot">&lt;-</span> residuals[, <span class="dv">1</span>]</span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>  epsilon_y <span class="ot">&lt;-</span> residuals[, <span class="dv">2</span>]</span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate mediator values</span></span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>  mu_m <span class="ot">&lt;-</span> alpha_m_i <span class="sc">+</span> beta_m_i <span class="sc">*</span> weeks</span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>  m_vals <span class="ot">&lt;-</span> mu_m <span class="sc">+</span> epsilon_m</span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>    <span class="co"># CENTER THE MEDIATOR BY PARTICIPANT</span></span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>  m_centered <span class="ot">&lt;-</span> m_vals <span class="sc">-</span> <span class="fu">mean</span>(m_vals)</span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate outcome values using CENTERED mediator</span></span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>  mu_y <span class="ot">&lt;-</span> alpha_y_i <span class="sc">+</span> beta_y_i <span class="sc">*</span> weeks <span class="sc">+</span> gamma_i <span class="sc">*</span> m_centered</span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a>  y_vals <span class="ot">&lt;-</span> mu_y <span class="sc">+</span> epsilon_y</span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">rbind.data.frame</span>(df, <span class="fu">data.frame</span>(<span class="at">m =</span> m_vals, <span class="at">y =</span> y_vals, <span class="at">week =</span> weeks,</span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">id =</span> <span class="fu">rep</span>(i, <span class="at">times =</span> <span class="fu">length</span>(weeks))))</span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>My aim for this code is that it can be used as a tool to test and make sense of different available methods for mediation analysis.</p>
<p>For now, let’s just plot both mediator and</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> week, <span class="at">group =</span> <span class="fu">as.factor</span>(id), <span class="at">color =</span> <span class="fu">as.factor</span>(id))) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> m), <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span> </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> m), <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> y), <span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> y), <span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">color =</span> <span class="st">"ID"</span>, <span class="at">y =</span> <span class="st">"Value"</span>) <span class="sc">+</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="mediation_sim_may_WIP_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="appendix-maximal-model-including-correlated-residuals." class="level3">
<h3 class="anchored" data-anchor-id="appendix-maximal-model-including-correlated-residuals.">Appendix: Maximal model including correlated residuals.</h3>
<p><strong>Note.</strong> Not yet updated <span class="math inline">\(\gamma\)</span> to apply to centered <span class="math inline">\(m\)</span></p>
<p><span class="math display">\[
\begin{align}
y_i &amp;= \mu_{y,i} + \epsilon_{y,i} \\
m_i &amp;= \mu_{m,i} + \epsilon_{m,i} \\
\mu_{y,i} &amp;= \alpha_{y,j[i]} + \beta_{y,j[i]}t_i + \gamma_{j[i]}m_i \\
\mu_{m,i} &amp;= \alpha_{m,j[i]} + \beta_{m,j[i]}t_i \\
\begin{pmatrix} \alpha_{m,j} \\ \beta_{m,j} \\ \alpha_{y,j} \\ \beta_{y,j} \\ \gamma_j \end{pmatrix} &amp;\sim \text{MVN}\left(\begin{pmatrix} \mu_{\alpha,m} \\ \mu_{\beta,m} \\ \mu_{\alpha,y} \\ \mu_{\beta,y} \\ \mu_{\gamma} \end{pmatrix}, \Sigma_{RE}\right) \\
\begin{pmatrix} \epsilon_{m,i} \\ \epsilon_{y,i} \end{pmatrix} &amp;\sim \text{MVN}\left(\begin{pmatrix} 0 \\ 0 \end{pmatrix}, \begin{pmatrix} \sigma_m^2 &amp; \rho_{\epsilon}\sigma_m\sigma_y \\ \rho_{\epsilon}\sigma_m\sigma_y &amp; \sigma_y^2 \end{pmatrix}\right)
\end{align}
\]</span></p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>© Copyright 2025, Vilgot Huhn</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>Built with <a href="https://quarto.org/">Quarto</a></p>
</div>
  </div>
</footer>




</body></html>